<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>å†›äº‹èŒä½ç®¡ç†ç³»ç»Ÿ - äº‘ç«¯å¤šè®¾å¤‡ç‰ˆ</title>
<style>
/* ä¿æŒæ‰€æœ‰åŸæœ‰CSSä¸å˜ */
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial}
body{background:linear-gradient(135deg,#1a237e 0%,#283593 100%);min-height:100vh;padding:20px;display:flex;justify-content:center;align-items:center}
#authContainer{max-width:400px;background:white;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.3);overflow:hidden}
.auth-header{background:linear-gradient(to right,#d32f2f,#b71c1c);color:white;padding:30px;text-align:center}
.auth-body{padding:40px 30px}
.auth-title{font-size:24px;color:#333;text-align:center;margin-bottom:10px;font-weight:bold}
.auth-subtitle{color:#666;text-align:center;margin-bottom:30px;font-size:14px}
.secret-input{position:relative;margin-bottom:25px}
.secret-input input{width:100%;padding:15px 20px;padding-left:50px;border:2px solid #ddd;border-radius:10px;font-size:16px;background:#f9f9f9}
.secret-input input:focus{border-color:#d32f2f;background:white;outline:none;box-shadow:0 0 0 3px rgba(211,47,47,0.1)}
.secret-icon{position:absolute;left:15px;top:50%;transform:translateY(-50%);color:#d32f2f;font-size:20px}
.auth-button{width:100%;padding:16px;background:linear-gradient(to right,#d32f2f,#b71c1c);color:white;border:none;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;margin-bottom:20px;transition:all 0.3s}
.auth-button:hover{background:linear-gradient(to right,#c62828,#a10f0f);transform:translateY(-2px);box-shadow:0 5px 15px rgba(211,47,47,0.3)}
.auth-note{background:#f8f9fa;padding:15px;border-radius:8px;border-left:4px solid #d32f2f;font-size:13px;color:#666;line-height:1.5}
.auth-error{color:#d32f2f;margin-top:10px;padding:10px;background:#ffebee;border-radius:5px;border:1px solid #ffcdd2;text-align:center;display:none}
.auth-success{color:#2e7d32;margin-top:10px;padding:10px;background:#e8f5e9;border-radius:5px;border:1px solid #c8e6c9;text-align:center;display:none}
.countdown{text-align:center;color:#666;font-size:12px;margin-top:15px}
.container{display:none;max-width:500px;background:white;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1);overflow:hidden}
.header{background:#1890ff;color:white;padding:20px;text-align:center}
.body{padding:30px}
.form-group{margin-bottom:20px}
label{display:block;margin-bottom:8px;color:#333;font-weight:bold}
input,select{width:100%;padding:12px;border:1px solid #ddd;border-radius:5px;font-size:16px}
input:focus,select:focus{border-color:#1890ff;outline:none;box-shadow:0 0 0 2px rgba(24,144,255,0.2)}
.btn{width:100%;padding:14px;background:#1890ff;color:white;border:none;border-radius:5px;font-size:16px;font-weight:bold;cursor:pointer;transition:background 0.3s}
.btn:hover{background:#096dd9}
.btn-success{background:#52c41a}
.btn-success:hover{background:#389e0d}
.btn-danger{background:#ff4d4f}
.btn-danger:hover{background:#d9363e}
.error{color:#ff4d4f;margin-top:10px;padding:10px;background:#fff2f0;border:1px solid #ffccc7;border-radius:5px;display:none}
.main-container{display:none;max-width:1200px;margin:0 auto}
.main-header{background:white;padding:15px 20px;margin-bottom:20px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);display:flex;justify-content:space-between;align-items:center}
.tabs{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap}
.tab{padding:12px 24px;background:white;border:1px solid #ddd;border-radius:5px;cursor:pointer;font-weight:bold;transition:all 0.3s}
.tab:hover{background:#f5f5f5}
.tab.active{background:#1890ff;color:white;border-color:#1890ff}
.content{background:white;padding:25px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);min-height:400px}
table{width:100%;border-collapse:collapse;margin-top:20px}
th{background:#fafafa;padding:12px;text-align:left;border-bottom:1px solid #ddd;font-weight:bold}
td{padding:12px;border-bottom:1px solid #f0f0f0}
tr:hover{background:#fafafa}
.badge{padding:4px 8px;border-radius:4px;font-size:12px;font-weight:bold;color:white;display:inline-block}
.action-btn{padding:6px 12px;border:none;border-radius:4px;cursor:pointer;font-size:14px;margin-right:5px}
.action-btn-primary{background:#1890ff;color:white}
.action-btn-danger{background:#ff4d4f;color:white}
.action-btn-success{background:#52c41a;color:white}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:20px;margin-bottom:30px}
.stat-card{background:white;padding:20px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);text-align:center}
.stat-card .number{font-size:32px;font-weight:bold;color:#1890ff;margin-bottom:10px}
.stat-card .label{color:#666;font-size:14px}
.locked-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);display:flex;justify-content:center;align-items:center;z-index:9999;flex-direction:column;color:white;text-align:center;padding:20px}
.lock-icon{font-size:80px;margin-bottom:20px;color:#d32f2f}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:10000;justify-content:center;align-items:center}
.modal-content{background:white;padding:30px;border-radius:10px;width:90%;max-width:400px}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.modal-title{font-size:20px;font-weight:bold}
.tab-content{display:none}

/* æ–°å¢ï¼šäº‘ç«¯åŒæ­¥ç›¸å…³æ ·å¼ */
.cloud-status {
    position: fixed;
    top: 10px;
    right: 10px;
    padding: 5px 15px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
    z-index: 10001;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.cloud-online {
    background: #52c41a;
    color: white;
    animation: pulse 2s infinite;
}

.cloud-offline {
    background: #fa8c16;
    color: white;
}

.cloud-error {
    background: #ff4d4f;
    color: white;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}

.sync-indicator {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 5px;
}

.sync-green { background: #52c41a; }
.sync-yellow { background: #fa8c16; }
.sync-red { background: #ff4d4f; }

.device-badge {
    background: #1890ff;
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 11px;
    margin-left: 10px;
}

.realtime-notification {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: white;
    padding: 15px 20px;
    border-radius: 10px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    border-left: 4px solid #1890ff;
    z-index: 9998;
    animation: slideIn 0.3s ease;
    max-width: 300px;
    display: none;
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

.conflict-modal {
    background: #fff7e6;
    border: 2px solid #fa8c16;
    border-radius: 10px;
    padding: 20px;
    margin: 20px 0;
}

.conflict-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

/* æ•°æ®åŒæ­¥é¡µé¢æ ·å¼ */
.sync-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
}

.sync-progress {
    height: 10px;
    background: #f0f0f0;
    border-radius: 5px;
    overflow: hidden;
    margin: 10px 0;
}

.sync-progress-bar {
    height: 100%;
    background: #52c41a;
    width: 0%;
    transition: width 0.3s;
}
</style>
</head>
<body>
<!-- äº‘ç«¯çŠ¶æ€æŒ‡ç¤ºå™¨ -->
<div id="cloudStatus" class="cloud-status cloud-offline">
    <span class="sync-indicator sync-red"></span>
    <span id="cloudStatusText">äº‘ç«¯ç¦»çº¿</span>
</div>

<!-- å®æ—¶é€šçŸ¥ -->
<div id="realtimeNotification" class="realtime-notification">
    <div style="font-weight:bold;margin-bottom:5px;">å®æ—¶æ›´æ–°</div>
    <div id="notificationMessage"></div>
</div>

<!-- åˆ›å»ºäº‘ç«¯æœåŠ¡å™¨å¯†ç éªŒè¯ -->
<div id="cloudCreatePasswordModal" class="modal">
<div class="modal-content"><div class="modal-header"><div class="modal-title">åˆ›å»ºäº‘ç«¯æœåŠ¡å™¨æƒé™éªŒè¯</div>
<button onclick="closeModal()" style="background:none;border:none;font-size:24px;cursor:pointer">Ã—</button></div>
<div class="form-group"><label>è¯·è¾“å…¥åˆ›å»ºæœåŠ¡å™¨å¯†ç </label><input type="password" id="cloudServerCreatePassword" placeholder="è¯·è¾“å…¥åˆ›å»ºæœåŠ¡å™¨å¯†ç "></div>
<button class="btn btn-success" onclick="checkCloudCreateServerPassword()">éªŒè¯å¯†ç </button>
<div class="error" id="cloudPasswordError" style="margin-top:10px"></div></div></div>

<!-- è¦†ç›–äº‘ç«¯æœåŠ¡å™¨ç¡®è®¤ -->
<div id="overwriteCloudModal" class="modal">
<div class="modal-content"><div class="modal-header"><div class="modal-title" style="color:#fa8c16">âš ï¸ è¦†ç›–äº‘ç«¯æœåŠ¡å™¨</div>
<button onclick="closeModal()" style="background:none;border:none;font-size:24px;cursor:pointer">Ã—</button></div>
<div style="margin-bottom:20px">
<p><strong>è­¦å‘Šï¼šè¯¥äº‘ç«¯è®¿é—®ç å·²å­˜åœ¨æœåŠ¡å™¨ï¼</strong></p>
<p style="margin:10px 0;color:#ff4d4f">è¦†ç›–å°†åˆ é™¤åŸæœ‰æœåŠ¡å™¨åŠå…¶æ‰€æœ‰æ•°æ®ï¼</p>
<div style="background:#fff7e6;padding:15px;border-radius:5px;margin:15px 0">
<p style="margin-bottom:5px"><strong>åŸæœ‰æœåŠ¡å™¨ä¿¡æ¯ï¼š</strong></p>
<p style="font-size:14px;margin:5px 0">æœåŠ¡å™¨åç§°: <span id="existingServerName">-</span></p>
<p style="font-size:14px;margin:5px 0">åˆ›å»ºæ—¶é—´: <span id="existingServerTime">-</span></p>
<p style="font-size:14px;margin:5px 0">ç”¨æˆ·æ•°é‡: <span id="existingServerUsers">-</span></p>
<p style="font-size:14px;margin:5px 0">èŒä½æ•°é‡: <span id="existingServerPositions">-</span></p>
</div>
<p style="color:#fa8c16;font-weight:bold;margin:10px 0">ç¡®å®šè¦è¦†ç›–å¹¶åˆ é™¤åŸæœ‰æ•°æ®å—ï¼Ÿ</p>
</div>
<div style="display:flex;gap:10px">
<button class="btn btn-danger" onclick="executeOverwriteCloud()">ç¡®è®¤è¦†ç›–</button>
<button class="btn" onclick="closeModal()">å–æ¶ˆ</button>
</div></div></div>

<!-- äº‘ç«¯æ•°æ®åŒæ­¥å†²çªå¤„ç† -->
<div id="conflictModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<div class="modal-title">æ•°æ®å†²çªè§£å†³</div>
<button onclick="closeModal()" style="background:none;border:none;font-size:24px;cursor:pointer">Ã—</button>
</div>
<div class="conflict-modal">
<p style="margin-bottom:10px"><strong>æ£€æµ‹åˆ°æœ¬åœ°å’Œäº‘ç«¯æ•°æ®ä¸ä¸€è‡´</strong></p>
<p style="margin-bottom:15px">è¯·é€‰æ‹©å¦‚ä½•å¤„ç†ï¼š</p>
<div class="conflict-actions">
<button class="btn btn-primary" onclick="resolveConflict('local')">ä½¿ç”¨æœ¬åœ°æ•°æ®</button>
<button class="btn btn-success" onclick="resolveConflict('cloud')">ä½¿ç”¨äº‘ç«¯æ•°æ®</button>
<button class="btn" onclick="resolveConflict('merge')">æ™ºèƒ½åˆå¹¶</button>
</div>
</div>
</div>
</div>

<!-- é”å®šç•Œé¢ -->
<div id="lockScreen" class="locked-screen" style="display:none">
<div class="lock-icon">ğŸ”’</div>
<h1 style="font-size:32px;margin-bottom:20px">ç³»ç»Ÿå·²é”å®š</h1>
<p style="font-size:18px;margin-bottom:30px">ç”±äºå¤šæ¬¡å°è¯•å¤±è´¥ï¼Œç³»ç»Ÿå·²è¢«é”å®š</p>
<div style="background:rgba(255,255,255,0.1);padding:30px;border-radius:15px">
<p style="font-size:16px;margin-bottom:10px">å‰©ä½™é”å®šæ—¶é—´ï¼š</p>
<p style="font-size:48px;font-weight:bold;font-family:monospace" id="lockTime">00:00</p>
</div>
<p style="margin-top:30px;font-size:14px;color:#ccc">é”å®šæœŸé—´æ— æ³•è®¿é—®ç³»ç»Ÿ</p>
</div>

<!-- ç³»ç»Ÿè®¿é—®éªŒè¯ -->
<div id="authContainer">
<div class="auth-header">
<div style="font-size:48px;margin-bottom:15px">ğŸ”</div>
<h1 style="font-size:28px;margin:0">å†›äº‹èŒä½ç®¡ç†ç³»ç»Ÿ</h1>
<p style="margin-top:10px;opacity:0.9;font-size:14px">äº‘ç«¯å¤šè®¾å¤‡åŒæ­¥ç‰ˆ</p>
</div>
<div class="auth-body">
<div class="auth-title">ç³»ç»Ÿè®¿é—®éªŒè¯</div>
<div class="auth-subtitle">è¯·è¾“å…¥ç³»ç»Ÿè®¿é—®å¯†é’¥ä»¥ç»§ç»­</div>
<div class="secret-input">
<span class="secret-icon">ğŸ”‘</span>
<input type="password" id="secretCode" placeholder="è¯·è¾“å…¥ç³»ç»Ÿè®¿é—®å¯†é’¥" onkeypress="if(event.key==='Enter')checkSecretCode()">
</div>
<button class="auth-button" onclick="checkSecretCode()">éªŒè¯å¹¶è¿›å…¥</button>
<div class="auth-note">
<div style="font-weight:bold;margin-bottom:8px;color:#d32f2f">âš ï¸ å®‰å…¨æç¤º</div>
<div style="margin-bottom:5px">â€¢ å‰©ä½™å°è¯•æ¬¡æ•°ï¼š<span id="attemptsLeft" style="font-weight:bold;color:#d32f2f">3</span> æ¬¡</div>
<div style="margin-bottom:5px">â€¢ å¤±è´¥3æ¬¡å°†é”å®šç³»ç»Ÿ30åˆ†é’Ÿ</div>
<div>â€¢ è¯·å‹¿æ³„éœ²ç³»ç»Ÿè®¿é—®å¯†é’¥</div>
</div>
<div class="auth-error" id="authError"></div>
<div class="auth-success" id="authSuccess"></div>
</div>
</div>

<!-- æœåŠ¡å™¨ç™»å½•/åˆ›å»ºç•Œé¢ -->
<div id="loginContainer" class="container">
<div class="header">
<h1 style="margin:0;font-size:24px">æœåŠ¡å™¨è®¿é—®</h1>
<p style="margin-top:8px;opacity:0.9;font-size:14px">æ”¯æŒäº‘ç«¯å¤šè®¾å¤‡åŒæ­¥</p>
</div>
<div class="body">
<div class="form-group">
<label>æœåŠ¡å™¨è®¿é—®ç ï¼ˆ8-16ä½å­—æ¯æ•°å­—ï¼‰</label>
<input type="text" id="serverKey" placeholder="è¯·è¾“å…¥æœåŠ¡å™¨è®¿é—®ç " maxlength="16">
</div>
<div class="form-group">
<label>ç”¨æˆ·è´¦å·</label>
<input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·è´¦å·">
</div>
<div class="form-group">
<label>ç”¨æˆ·å¯†ç </label>
<input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç " onkeypress="if(event.key==='Enter')login()">
</div>
<button class="btn" onclick="login()">ç™»å½•æœåŠ¡å™¨</button>
<button class="btn btn-success" onclick="showCreateServer()">åˆ›å»ºæ–°æœåŠ¡å™¨</button>
<div class="error" id="loginError"></div>
</div>
</div>

<!-- åˆ›å»ºæœåŠ¡å™¨ç•Œé¢ -->
<div id="createContainer" class="container">
<div class="header">
<h1 style="margin:0;font-size:24px">åˆ›å»ºæ–°æœåŠ¡å™¨</h1>
</div>
<div class="body">
<div class="form-group">
<label>æœåŠ¡å™¨åç§°</label>
<input type="text" id="newServerName" placeholder="è¯·è¾“å…¥æœåŠ¡å™¨åç§°">
</div>
<div class="form-group">
<label>æœåŠ¡å™¨è®¿é—®ç ï¼ˆ8-16ä½å­—æ¯æ•°å­—ï¼‰</label>
<input type="text" id="newServerKey" placeholder="è¯·è¾“å…¥æœåŠ¡å™¨è®¿é—®ç ï¼ˆå»ºè®®ä½¿ç”¨å¤æ‚ç»„åˆï¼‰" maxlength="16">
<small style="color:#666;display:block;margin-top:5px">è®¿é—®ç ç”¨äºæ ‡è¯†æœåŠ¡å™¨ï¼Œè¯·å¦¥å–„ä¿ç®¡</small>
</div>
<div class="form-group">
<label>ç®¡ç†å‘˜è´¦å·</label>
<input type="text" id="newUsername" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜è´¦å·">
</div>
<div class="form-group">
<label>ç®¡ç†å‘˜å¯†ç </label>
<input type="password" id="newPassword" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ">
</div>
<div class="form-group">
<label>
<input type="checkbox" id="isCloudServerCheck" style="width:auto;margin-right:8px">
åˆ›å»ºä¸ºäº‘ç«¯æœåŠ¡å™¨ï¼ˆæ”¯æŒå¤šè®¾å¤‡åŒæ­¥ï¼‰
</label>
<small style="color:#666;display:block;margin-top:5px">äº‘ç«¯æœåŠ¡å™¨æ•°æ®å­˜å‚¨åœ¨äº‘ç«¯ï¼Œå¯åœ¨å¤šä¸ªè®¾å¤‡é—´åŒæ­¥</small>
</div>
<button class="btn btn-success" onclick="createServer()">åˆ›å»ºæœåŠ¡å™¨</button>
<button class="btn" onclick="backToLogin()">è¿”å›ç™»å½•</button>
<div class="error" id="createError"></div>
</div>
</div>

<!-- ä¸»ç•Œé¢ -->
<div id="mainContainer" class="main-container">
<div class="main-header">
<div>
<h2 style="margin:0" id="serverTitle">æœåŠ¡å™¨ç®¡ç†</h2>
<small id="userInfo" style="color:#666"></small>
<span id="cloudServerBadge" class="device-badge" style="display:none">â˜ï¸ äº‘ç«¯æœåŠ¡å™¨</span>
</div>
<div>
<button class="btn" onclick="logout()" style="width:auto;padding:10px 20px">é€€å‡ºç™»å½•</button>
</div>
</div>

<div class="tabs">
<div class="tab active" onclick="switchTab('dashboard')">ğŸ“Š ä»ªè¡¨ç›˜</div>
<div class="tab" onclick="switchTab('personnel')">ğŸ‘¥ äººå‘˜ç®¡ç†</div>
<div class="tab" onclick="switchTab('promote')">â¬†ï¸ èŒä½æ™‹å‡</div>
<div class="tab" onclick="switchTab('users')">ğŸ” ç”¨æˆ·ç®¡ç†</div>
<div class="tab" onclick="switchTab('logs')">ğŸ“ æ“ä½œæ—¥å¿—</div>
<div class="tab" onclick="switchTab('sync')" id="syncTab" style="display:none">â˜ï¸ æ•°æ®åŒæ­¥</div>
<div class="tab" onclick="switchTab('settings')">âš™ï¸ ç³»ç»Ÿè®¾ç½®</div>
</div>

<!-- ä»ªè¡¨ç›˜ -->
<div id="dashboardTab" class="tab-content" style="display:block">
<h3 style="margin-bottom:20px">ç³»ç»Ÿæ¦‚è§ˆ</h3>
<div class="stats">
<div class="stat-card">
<div class="number" id="totalPersonnel">0</div>
<div class="label">æ€»äººæ•°</div>
</div>
<div class="stat-card">
<div class="number" id="totalUsers">0</div>
<div class="label">ç”¨æˆ·æ•°</div>
</div>
<div class="stat-card">
<div class="number" id="totalLogs">0</div>
<div class="label">æ“ä½œè®°å½•</div>
</div>
</div>
<h4 style="margin-top:30px;margin-bottom:15px">æœ€è¿‘æ“ä½œ</h4>
<div id="recentLogs"></div>
</div>

<!-- äººå‘˜ç®¡ç† -->
<div id="personnelTab" class="tab-content">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
<h3 style="margin:0">äººå‘˜åˆ—è¡¨</h3>
<button class="btn btn-success" onclick="showAddPersonnel()" style="width:auto;padding:10px 20px">â• æ·»åŠ äººå‘˜</button>
</div>
<table id="personnelTable">
<thead>
<tr>
<th>å§“å</th>
<th>èŒä½</th>
<th>å†›è¡”</th>
<th>çŠ¶æ€</th>
<th>æ“ä½œ</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<!-- èŒä½æ™‹å‡ -->
<div id="promoteTab" class="tab-content">
<h3 style="margin-bottom:20px">èŒä½æ™‹å‡ç®¡ç†</h3>
<div class="form-group">
<label>é€‰æ‹©äººå‘˜</label>
<select id="promoteSelect" onchange="updatePromoteInfo()">
<option value="">è¯·é€‰æ‹©äººå‘˜</option>
</select>
</div>
<div id="promoteInfo" style="display:none;background:#f5f5f5;padding:20px;border-radius:8px;margin-bottom:20px">
<h4 style="margin-bottom:15px">å½“å‰ä¿¡æ¯</h4>
<p style="margin-bottom:10px"><strong>å½“å‰èŒä½ï¼š</strong><span id="currentPosition"></span></p>
<p style="margin-bottom:10px"><strong>å½“å‰å†›è¡”ï¼š</strong><span id="currentRank"></span></p>
</div>
<div class="form-group">
<label>æ–°èŒä½</label>
<select id="newPosition">
<option value="">è¯·é€‰æ‹©æ–°èŒä½</option>
</select>
</div>
<div class="form-group">
<label>æ–°å†›è¡”</label>
<select id="newRank">
<option value="">è¯·é€‰æ‹©æ–°å†›è¡”</option>
</select>
</div>
<button class="btn btn-success" onclick="promotePersonnel()">ç¡®è®¤æ™‹å‡</button>
</div>

<!-- ç”¨æˆ·ç®¡ç† -->
<div id="usersTab" class="tab-content">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
<h3 style="margin:0">ç”¨æˆ·åˆ—è¡¨</h3>
<button class="btn btn-success" onclick="showAddUser()" style="width:auto;padding:10px 20px">â• æ·»åŠ ç”¨æˆ·</button>
</div>
<table id="usersTable">
<thead>
<tr>
<th>ç”¨æˆ·å</th>
<th>è§’è‰²</th>
<th>çŠ¶æ€</th>
<th>æ“ä½œ</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<!-- æ“ä½œæ—¥å¿— -->
<div id="logsTab" class="tab-content">
<h3 style="margin-bottom:20px">æ“ä½œæ—¥å¿—</h3>
<table id="logsTable">
<thead>
<tr>
<th style="width:180px">æ—¶é—´</th>
<th>æ“ä½œ</th>
<th>æ“ä½œäºº</th>
<th>è¯¦æƒ…</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<!-- æ•°æ®åŒæ­¥é¡µé¢ -->
<div id="syncTab-content" class="tab-content">
<h3 style="margin-bottom:20px">â˜ï¸ äº‘ç«¯æ•°æ®åŒæ­¥</h3>

<div class="sync-section">
<h4 style="margin-bottom:15px">åŒæ­¥çŠ¶æ€</h4>
<div style="display:flex;align-items:center;gap:15px;margin-bottom:15px">
<div>
<span class="sync-indicator" id="syncStatusIndicator"></span>
<strong id="syncStatusText">æ£€æŸ¥ä¸­...</strong>
</div>
<button class="btn btn-primary" onclick="manualSync()" style="width:auto;padding:8px 16px">ğŸ”„ æ‰‹åŠ¨åŒæ­¥</button>
</div>
<div style="font-size:14px;color:#666">
<p style="margin:5px 0">æœ€ååŒæ­¥: <span id="lastSyncTime">ä»æœª</span></p>
<p style="margin:5px 0">æœåŠ¡å™¨: <span id="currentServerInfo">-</span></p>
<p style="margin:5px 0">è®¾å¤‡æ ‡è¯†: <span id="deviceId">-</span></p>
</div>
</div>

<div class="sync-section">
<h4 style="margin-bottom:15px">åŒæ­¥è®¾ç½®</h4>
<div style="margin-bottom:15px">
<label style="display:flex;align-items:center;gap:10px">
<input type="checkbox" id="autoSyncEnabled" onchange="toggleAutoSync()" style="width:auto">
<span>å¯ç”¨è‡ªåŠ¨åŒæ­¥ï¼ˆæ¯30ç§’ï¼‰</span>
</label>
</div>
<div style="margin-bottom:15px">
<label style="display:flex;align-items:center;gap:10px">
<input type="checkbox" id="conflictNotification" style="width:auto">
<span>å†²çªæ—¶æ˜¾ç¤ºé€šçŸ¥</span>
</label>
</div>
</div>

<div class="sync-section">
<h4 style="margin-bottom:15px">æ•°æ®ç»Ÿè®¡</h4>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px">
<div style="background:white;padding:15px;border-radius:8px">
<div style="color:#666;font-size:14px;margin-bottom:5px">æœ¬åœ°è®°å½•æ•°</div>
<div style="font-size:24px;font-weight:bold;color:#1890ff" id="localRecordCount">0</div>
</div>
<div style="background:white;padding:15px;border-radius:8px">
<div style="color:#666;font-size:14px;margin-bottom:5px">äº‘ç«¯è®°å½•æ•°</div>
<div style="font-size:24px;font-weight:bold;color:#52c41a" id="cloudRecordCount">0</div>
</div>
<div style="background:white;padding:15px;border-radius:8px">
<div style="color:#666;font-size:14px;margin-bottom:5px">å¾…åŒæ­¥æ›´æ”¹</div>
<div style="font-size:24px;font-weight:bold;color:#fa8c16" id="pendingChanges">0</div>
</div>
</div>
</div>

<div class="sync-section">
<h4 style="margin-bottom:15px">åŒæ­¥å†å²</h4>
<div id="syncHistory" style="max-height:300px;overflow-y:auto">
<p style="color:#999;text-align:center;padding:20px">æš‚æ— åŒæ­¥å†å²</p>
</div>
</div>
</div>

<!-- ç³»ç»Ÿè®¾ç½® -->
<div id="settingsTab" class="tab-content">
<h3 style="margin-bottom:20px">ç³»ç»Ÿè®¾ç½®</h3>

<div style="background:#f5f5f5;padding:20px;border-radius:8px;margin-bottom:20px">
<h4 style="margin-bottom:15px">æœåŠ¡å™¨ä¿¡æ¯</h4>
<p style="margin-bottom:10px"><strong>æœåŠ¡å™¨åç§°ï¼š</strong><span id="settingsServerName">-</span></p>
<p style="margin-bottom:10px"><strong>æœåŠ¡å™¨è®¿é—®ç ï¼š</strong><span id="settingsServerKey">-</span></p>
<p style="margin-bottom:10px"><strong>åˆ›å»ºæ—¶é—´ï¼š</strong><span id="settingsCreateTime">-</span></p>
<p style="margin-bottom:10px"><strong>åˆ›å»ºè€…ï¼š</strong><span id="settingsCreator">-</span></p>
<p style="margin-bottom:10px"><strong>æœåŠ¡å™¨ç±»å‹ï¼š</strong><span id="settingsServerType">-</span></p>
</div>

<div style="background:#fff7e6;padding:20px;border-radius:8px;border-left:4px solid #fa8c16;margin-bottom:20px">
<h4 style="margin-bottom:15px;color:#fa8c16">âš ï¸ å±é™©æ“ä½œ</h4>
<p style="margin-bottom:15px;color:#666">ä»¥ä¸‹æ“ä½œå°†æ°¸ä¹…åˆ é™¤æœåŠ¡å™¨åŠå…¶æ‰€æœ‰æ•°æ®ï¼Œè¯·è°¨æ…æ“ä½œ</p>
<button class="btn btn-danger" onclick="showDeleteModal()" style="width:auto;padding:10px 20px">ğŸ—‘ï¸ åˆ é™¤æœåŠ¡å™¨</button>
</div>
</div>
</div>

<!-- æ·»åŠ äººå‘˜æ¨¡æ€æ¡† -->
<div id="addPersonnelModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<div class="modal-title">æ·»åŠ äººå‘˜</div>
<button onclick="closeModal()" style="background:none;border:none;font-size:24px;cursor:pointer">Ã—</button>
</div>
<div class="form-group">
<label>å§“å</label>
<input type="text" id="personnelName" placeholder="è¯·è¾“å…¥å§“å">
</div>
<div class="form-group">
<label>èŒä½</label>
<select id="personnelPosition">
<option value="">è¯·é€‰æ‹©èŒä½</option>
</select>
</div>
<div class="form-group">
<label>å†›è¡”</label>
<select id="personnelRank">
<option value="">è¯·é€‰æ‹©å†›è¡”</option>
</select>
</div>
<button class="btn btn-success" onclick="addPersonnel()">ç¡®è®¤æ·»åŠ </button>
</div>
</div>

<!-- æ·»åŠ ç”¨æˆ·æ¨¡æ€æ¡† -->
<div id="addUserModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<div class="modal-title">æ·»åŠ ç”¨æˆ·</div>
<button onclick="closeModal()" style="background:none;border:none;font-size:24px;cursor:pointer">Ã—</button>
</div>
<div class="form-group">
<label>ç”¨æˆ·å</label>
<input type="text" id="newUserUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
</div>
<div class="form-group">
<label>å¯†ç </label>
<input type="password" id="newUserPassword" placeholder="è¯·è¾“å…¥å¯†ç ">
</div>
<div class="form-group">
<label>è§’è‰²</label>
<select id="newUserRole">
<option value="admin">ç®¡ç†å‘˜</option>
<option value="user">æ™®é€šç”¨æˆ·</option>
</select>
</div>
<button class="btn btn-success" onclick="addUser()">ç¡®è®¤æ·»åŠ </button>
</div>
</div>

<!-- åˆ é™¤æœåŠ¡å™¨ç¡®è®¤æ¨¡æ€æ¡† -->
<div id="deleteModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<div class="modal-title" style="color:#ff4d4f">âš ï¸ åˆ é™¤æœåŠ¡å™¨</div>
<button onclick="closeModal()" style="background:none;border:none;font-size:24px;cursor:pointer">Ã—</button>
</div>
<div style="margin-bottom:20px">
<p style="color:#ff4d4f;font-weight:bold;margin-bottom:15px">è­¦å‘Šï¼šæ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼</p>
<p style="margin-bottom:10px">æ‚¨å³å°†åˆ é™¤æœåŠ¡å™¨ï¼š<strong id="deleteServerName">-</strong></p>
<p style="margin-bottom:15px">åˆ é™¤åå°†æ°¸ä¹…ä¸¢å¤±æ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul style="margin-left:20px;color:#666">
<li>æ‰€æœ‰äººå‘˜ä¿¡æ¯</li>
<li>æ‰€æœ‰ç”¨æˆ·è´¦å·</li>
<li>æ‰€æœ‰æ“ä½œæ—¥å¿—</li>
<li>æœåŠ¡å™¨é…ç½®</li>
</ul>
</div>
<div class="form-group">
<label>è¯·è¾“å…¥æ‚¨çš„å¯†ç ä»¥ç¡®è®¤åˆ é™¤</label>
<input type="password" id="deleteConfirmPassword" placeholder="è¯·è¾“å…¥æ‚¨çš„å¯†ç ">
</div>
<button class="btn btn-danger" onclick="confirmDeleteServer()">ç¡®è®¤åˆ é™¤</button>
<button class="btn" onclick="closeModal()">å–æ¶ˆ</button>
</div>
</div>

<script>
// ==================== å…¨å±€å˜é‡ ====================
const SYSTEM_SECRET = '123456';
const CLOUD_SERVER_CREATE_PASSWORD = '1235';
const MAX_ATTEMPTS = 5;
const LOCK_TIME = 30 * 60 * 1000;

let failedAttempts = 0;
let lockUntil = 0;
let currentUser = null;
let currentServer = null;
let serverData = { info: null, users: [], personnel: [], logs: [] };

// äº‘ç«¯åŒæ­¥ç›¸å…³å˜é‡
let isCloudServer = false;
let cloudSyncEnabled = false;
let syncIntervalId = null;
let deviceId = generateDeviceId();

// äº‘ç«¯é…ç½®
const CLOUD_CONFIG = {
    CLOUD_PREFIX: 'cloud_',
    SYNC_INTERVAL: 30000,
    MAX_CONFLICT_RETRIES: 3
};

// ==================== èŒä½å’Œå†›è¡”æ•°æ® ====================
const positions = [
    { id: 1, name: 'å£«å…µ' },
    { id: 2, name: 'ç­é•¿' },
    { id: 3, name: 'æ’é•¿' },
    { id: 4, name: 'è¿é•¿' },
    { id: 5, name: 'è¥é•¿' },
    { id: 6, name: 'å›¢é•¿' },
    { id: 7, name: 'æ—…é•¿' },
    { id: 8, name: 'å¸ˆé•¿' },
    { id: 9, name: 'å†›é•¿' }
];

const ranks = [
    { id: 1, name: 'åˆ—å…µ', color: '#8c8c8c' },
    { id: 2, name: 'ä¸Šç­‰å…µ', color: '#595959' },
    { id: 3, name: 'ä¸‹å£«', color: '#1890ff' },
    { id: 4, name: 'ä¸­å£«', color: '#096dd9' },
    { id: 5, name: 'ä¸Šå£«', color: '#0050b3' },
    { id: 6, name: 'å°‘å°‰', color: '#52c41a' },
    { id: 7, name: 'ä¸­å°‰', color: '#389e0d' },
    { id: 8, name: 'ä¸Šå°‰', color: '#237804' },
    { id: 9, name: 'å°‘æ ¡', color: '#fa8c16' },
    { id: 10, name: 'ä¸­æ ¡', color: '#d46b08' },
    { id: 11, name: 'ä¸Šæ ¡', color: '#ad4e00' },
    { id: 12, name: 'å°‘å°†', color: '#ff4d4f' },
    { id: 13, name: 'ä¸­å°†', color: '#cf1322' },
    { id: 14, name: 'ä¸Šå°†', color: '#a8071a' }
];

// ==================== åˆå§‹åŒ– ====================
window.onload = function() {
    loadAttempts();
    if (!checkLockStatus()) return;
    
    const savedUser = localStorage.getItem('currentUser');
    const savedServerKey = localStorage.getItem('currentServerKey');
    
    if (savedUser && savedServerKey) {
        currentUser = JSON.parse(savedUser);
        const serverKey = savedServerKey;
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯äº‘ç«¯æœåŠ¡å™¨
        const cloudData = localStorage.getItem(CLOUD_CONFIG.CLOUD_PREFIX + serverKey);
        if (cloudData) {
            isCloudServer = true;
            currentServer = { key: serverKey, isCloud: true };
            serverData = JSON.parse(cloudData);
            cloudSyncEnabled = true;
            updateCloudStatus('online');
            startAutoSync();
        } else {
            const localData = localStorage.getItem('server_' + serverKey);
            if (localData) {
                isCloudServer = false;
                currentServer = { key: serverKey, isCloud: false };
                serverData = JSON.parse(localData);
                updateCloudStatus('offline');
            } else {
                localStorage.removeItem('currentUser');
                localStorage.removeItem('currentServerKey');
                return;
            }
        }
        
        document.getElementById('authContainer').style.display = 'none';
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('mainContainer').style.display = 'block';
        initMainInterface();
    }
    
    setTimeout(() => {
        document.getElementById('secretCode').focus();
    }, 100);
};

// ==================== è®¾å¤‡IDç”Ÿæˆ ====================
function generateDeviceId() {
    let deviceId = localStorage.getItem('deviceId');
    if (!deviceId) {
        deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('deviceId', deviceId);
    }
    return deviceId;
}

// ==================== äº‘ç«¯çŠ¶æ€ç®¡ç† ====================
function updateCloudStatus(status) {
    const statusDiv = document.getElementById('cloudStatus');
    const statusText = document.getElementById('cloudStatusText');
    const indicator = statusDiv.querySelector('.sync-indicator');
    
    statusDiv.className = 'cloud-status';
    
    switch(status) {
        case 'online':
            statusDiv.classList.add('cloud-online');
            statusText.textContent = 'â˜ï¸ äº‘ç«¯åœ¨çº¿';
            indicator.className = 'sync-indicator sync-green';
            break;
        case 'offline':
            statusDiv.classList.add('cloud-offline');
            statusText.textContent = 'ğŸ“± æœ¬åœ°æ¨¡å¼';
            indicator.className = 'sync-indicator sync-yellow';
            break;
        case 'syncing':
            statusDiv.classList.add('cloud-online');
            statusText.textContent = 'ğŸ”„ åŒæ­¥ä¸­...';
            indicator.className = 'sync-indicator sync-green';
            break;
        case 'error':
            statusDiv.classList.add('cloud-error');
            statusText.textContent = 'âŒ åŒæ­¥é”™è¯¯';
            indicator.className = 'sync-indicator sync-red';
            break;
    }
}

// ==================== å®æ—¶é€šçŸ¥ ====================
function showNotification(message, duration = 3000) {
    const notification = document.getElementById('realtimeNotification');
    const messageDiv = document.getElementById('notificationMessage');
    
    messageDiv.textContent = message;
    notification.style.display = 'block';
    
    setTimeout(() => {
        notification.style.display = 'none';
    }, duration);
}

// ==================== è‡ªåŠ¨åŒæ­¥ ====================
function startAutoSync() {
    if (!isCloudServer || !cloudSyncEnabled) return;
    
    if (syncIntervalId) {
        clearInterval(syncIntervalId);
    }
    
    syncIntervalId = setInterval(() => {
        syncWithCloud();
    }, CLOUD_CONFIG.SYNC_INTERVAL);
}

function syncWithCloud() {
    if (!isCloudServer || !currentServer) return;
    
    updateCloudStatus('syncing');
    
    setTimeout(() => {
        const cloudData = localStorage.getItem(CLOUD_CONFIG.CLOUD_PREFIX + currentServer.key);
        if (cloudData) {
            const parsedData = JSON.parse(cloudData);
            
            if (parsedData.info && parsedData.info.lastSync !== serverData.info.lastSync) {
                serverData = parsedData;
                loadPersonnelList();
                loadUsersList();
                updateDashboard();
                showNotification('âœ… æ•°æ®å·²ä»äº‘ç«¯åŒæ­¥');
            }
        }
        
        updateCloudStatus('online');
    }, 500);
}

function manualSync() {
    if (!isCloudServer) {
        alert('å½“å‰æœåŠ¡å™¨ä¸æ˜¯äº‘ç«¯æœåŠ¡å™¨');
        return;
    }
    
    syncWithCloud();
    showNotification('ğŸ”„ æ‰‹åŠ¨åŒæ­¥å®Œæˆ');
}

function toggleAutoSync() {
    const enabled = document.getElementById('autoSyncEnabled').checked;
    
    if (enabled) {
        cloudSyncEnabled = true;
        startAutoSync();
        showNotification('âœ… è‡ªåŠ¨åŒæ­¥å·²å¯ç”¨');
    } else {
        cloudSyncEnabled = false;
        if (syncIntervalId) {
            clearInterval(syncIntervalId);
            syncIntervalId = null;
        }
        showNotification('â¸ï¸ è‡ªåŠ¨åŒæ­¥å·²æš‚åœ');
    }
}

// ==================== ç³»ç»Ÿè®¿é—®éªŒè¯ ====================
function checkSecretCode() {
    const code = document.getElementById('secretCode').value.trim();
    const errorDiv = document.getElementById('authError');
    const successDiv = document.getElementById('authSuccess');
    
    if (!code) {
        errorDiv.textContent = 'è¯·è¾“å…¥ç³»ç»Ÿè®¿é—®å¯†é’¥';
        errorDiv.style.display = 'block';
        successDiv.style.display = 'none';
        return;
    }
    
    if (code === SYSTEM_SECRET) {
        successDiv.textContent = 'âœ“ éªŒè¯æˆåŠŸï¼æ­£åœ¨è¿›å…¥ç³»ç»Ÿ...';
        successDiv.style.display = 'block';
        errorDiv.style.display = 'none';
        
        failedAttempts = 0;
        saveAttempts();
        updateAttemptsDisplay();
        
        setTimeout(() => {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('loginContainer').style.display = 'block';
            document.getElementById('serverKey').focus();
        }, 1000);
    } else {
        failedAttempts++;
        saveAttempts();
        updateAttemptsDisplay();
        
        const attemptsLeft = MAX_ATTEMPTS - failedAttempts;
        
        if (attemptsLeft <= 0) {
            errorDiv.textContent = 'âŒ å¤±è´¥æ¬¡æ•°è¿‡å¤šï¼Œç³»ç»Ÿå·²é”å®š30åˆ†é’Ÿ';
            errorDiv.style.display = 'block';
            successDiv.style.display = 'none';
            lockSystem();
        } else {
            errorDiv.textContent = `âŒ å¯†é’¥é”™è¯¯ï¼å‰©ä½™ ${attemptsLeft} æ¬¡å°è¯•æœºä¼š`;
            errorDiv.style.display = 'block';
            successDiv.style.display = 'none';
        }
        
        document.getElementById('secretCode').value = '';
        document.getElementById('secretCode').focus();
    }
}

// ==================== æœåŠ¡å™¨ç™»å½• ====================
function login() {
    const serverKey = document.getElementById('serverKey').value.trim();
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    const errorDiv = document.getElementById('loginError');
    
    if (!serverKey || !username || !password) {
        errorDiv.textContent = 'è¯·å¡«å†™å®Œæ•´ä¿¡æ¯';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (!/^[a-zA-Z0-9]{8,16}$/.test(serverKey)) {
        errorDiv.textContent = 'æœåŠ¡å™¨è®¿é—®ç æ ¼å¼é”™è¯¯ï¼ˆ8-16ä½å­—æ¯æ•°å­—ï¼‰';
        errorDiv.style.display = 'block';
        return;
    }
    
    // å…ˆæ£€æŸ¥äº‘ç«¯æœåŠ¡å™¨
    const cloudData = localStorage.getItem(CLOUD_CONFIG.CLOUD_PREFIX + serverKey);
    if (cloudData) {
        const data = JSON.parse(cloudData);
        const user = data.users.find(u => u.username === username && u.password === password);
        
        if (user) {
            isCloudServer = true;
            currentServer = { key: serverKey, isCloud: true };
            currentUser = user;
            serverData = data;
            
            localStorage.setItem('currentUser', JSON.stringify(user));
            localStorage.setItem('currentServerKey', serverKey);
            
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'block';
            
            cloudSyncEnabled = true;
            updateCloudStatus('online');
            startAutoSync();
            
            initMainInterface();
            return;
        }
    }
    
    // æ£€æŸ¥æœ¬åœ°æœåŠ¡å™¨
    const localData = localStorage.getItem('server_' + serverKey);
    if (localData) {
        const data = JSON.parse(localData);
        const user = data.users.find(u => u.username === username && u.password === password);
        
        if (user) {
            isCloudServer = false;
            currentServer = { key: serverKey, isCloud: false };
            currentUser = user;
            serverData = data;
            
            localStorage.setItem('currentUser', JSON.stringify(user));
            localStorage.setItem('currentServerKey', serverKey);
            
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'block';
            
            updateCloudStatus('offline');
            
            initMainInterface();
            return;
        }
    }
    
    errorDiv.textContent = 'æœåŠ¡å™¨ä¸å­˜åœ¨æˆ–ç”¨æˆ·åå¯†ç é”™è¯¯';
    errorDiv.style.display = 'block';
}

// ==================== æ˜¾ç¤ºåˆ›å»ºæœåŠ¡å™¨ç•Œé¢ ====================
function showCreateServer() {
    document.getElementById('loginContainer').style.display = 'none';
    document.getElementById('createContainer').style.display = 'block';
    document.getElementById('newServerName').focus();
}

function backToLogin() {
    document.getElementById('createContainer').style.display = 'none';
    document.getElementById('loginContainer').style.display = 'block';
    document.getElementById('createError').style.display = 'none';
    document.getElementById('serverKey').focus();
}

// ==================== åˆ›å»ºæœåŠ¡å™¨ ====================
function createServer() {
    const serverName = document.getElementById('newServerName').value.trim();
    const serverKey = document.getElementById('newServerKey').value.trim();
    const username = document.getElementById('newUsername').value.trim();
    const password = document.getElementById('newPassword').value.trim();
    const isCloud = document.getElementById('isCloudServerCheck').checked;
    const errorDiv = document.getElementById('createError');
    
    if (!serverName || !serverKey || !username || !password) {
        errorDiv.textContent = 'è¯·å¡«å†™å®Œæ•´ä¿¡æ¯';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (!/^[a-zA-Z0-9]{8,16}$/.test(serverKey)) {
        errorDiv.textContent = 'æœåŠ¡å™¨è®¿é—®ç æ ¼å¼é”™è¯¯ï¼ˆ8-16ä½å­—æ¯æ•°å­—ï¼‰';
        errorDiv.style.display = 'block';
        return;
    }
    
    // å¦‚æœæ˜¯äº‘ç«¯æœåŠ¡å™¨ï¼Œéœ€è¦éªŒè¯åˆ›å»ºæƒé™
    if (isCloud) {
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåäº‘ç«¯æœåŠ¡å™¨
        const existingCloudData = localStorage.getItem(CLOUD_CONFIG.CLOUD_PREFIX + serverKey);
        if (existingCloudData) {
            const existing = JSON.parse(existingCloudData);
            document.getElementById('existingServerName').textContent = existing.info.name;
            document.getElementById('existingServerTime').textContent = new Date(existing.info.createdAt).toLocaleString();
            document.getElementById('existingServerUsers').textContent = existing.users.length;
            document.getElementById('existingServerPositions').textContent = existing.personnel ? existing.personnel.length : 0;
            
            // ä¿å­˜åˆ›å»ºä¿¡æ¯ä»¥ä¾¿è¦†ç›–æ—¶ä½¿ç”¨
            window.pendingCloudServer = { serverName, serverKey, username, password };
            
            document.getElementById('overwriteCloudModal').style.display = 'flex';
            return;
        }
        
        // å¦‚æœä¸å­˜åœ¨ï¼ŒéªŒè¯åˆ›å»ºå¯†ç 
        window.pendingCloudServer = { serverName, serverKey, username, password };
        document.getElementById('cloudServerCreatePassword').value = '';
        document.getElementById('cloudPasswordError').style.display = 'none';
        document.getElementById('cloudCreatePasswordModal').style.display = 'flex';
        return;
    }
    
    // åˆ›å»ºæœ¬åœ°æœåŠ¡å™¨
    const localKey = 'server_' + serverKey;
    if (localStorage.getItem(localKey)) {
        errorDiv.textContent = 'è¯¥æœåŠ¡å™¨è®¿é—®ç å·²è¢«ä½¿ç”¨';
        errorDiv.style.display = 'block';
        return;
    }
    
    executeCreateServer(serverName, serverKey, username, password, false);
}

// ==================== éªŒè¯äº‘ç«¯åˆ›å»ºå¯†ç  ====================
function checkCloudCreateServerPassword() {
    const password = document.getElementById('cloudServerCreatePassword').value;
    const errorDiv = document.getElementById('cloudPasswordError');
    
    if (password !== CLOUD_SERVER_CREATE_PASSWORD) {
        errorDiv.textContent = 'åˆ›å»ºæœåŠ¡å™¨å¯†ç é”™è¯¯';
        errorDiv.style.display = 'block';
        return;
    }
    
    closeModal();
    
    const { serverName, serverKey, username, password: userPassword } = window.pendingCloudServer;
    executeCreateServer(serverName, serverKey, username, userPassword, true);
}

// ==================== æ‰§è¡Œè¦†ç›–äº‘ç«¯æœåŠ¡å™¨ ====================
function executeOverwriteCloud() {
    closeModal();
    
    // éªŒè¯åˆ›å»ºå¯†ç 
    window.pendingCloudServer.isOverwrite = true;
    document.getElementById('cloudServerCreatePassword').value = '';
    document.getElementById('cloudPasswordError').style.display = 'none';
    document.getElementById('cloudCreatePasswordModal').style.display = 'flex';
}

// ==================== æ‰§è¡Œåˆ›å»ºæœåŠ¡å™¨ ====================
function executeCreateServer(serverName, serverKey, username, password, isCloud) {
    const userId = Date.now().toString();
    
    const newServer = {
        info: {
            name: serverName,
            key: serverKey,
            createdAt: new Date().toISOString(),
            creatorId: userId,
            lastSync: new Date().toISOString(),
            isCloud: isCloud
        },
        users: [{
            id: userId,
            username: username,
            password: password,
            role: 'admin',
            status: 'active'
        }],
        personnel: [],
        logs: [{
            action: 'åˆ›å»ºæœåŠ¡å™¨',
            user: username,
            timestamp: new Date().toISOString(),
            details: `åˆ›å»º${isCloud ? 'äº‘ç«¯' : 'æœ¬åœ°'}æœåŠ¡å™¨: ${serverName}`
        }]
    };
    
    const storageKey = isCloud ? CLOUD_CONFIG.CLOUD_PREFIX + serverKey : 'server_' + serverKey;
    localStorage.setItem(storageKey, JSON.stringify(newServer));
    
    isCloudServer = isCloud;
    currentServer = { key: serverKey, isCloud: isCloud };
    currentUser = newServer.users[0];
    serverData = newServer;
    
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    localStorage.setItem('currentServerKey', serverKey);
    
    document.getElementById('createContainer').style.display = 'none';
    document.getElementById('mainContainer').style.display = 'block';
    
    if (isCloud) {
        cloudSyncEnabled = true;
        updateCloudStatus('online');
        startAutoSync();
    } else {
        updateCloudStatus('offline');
    }
    
    initMainInterface();
}

// ==================== åˆå§‹åŒ–ä¸»ç•Œé¢ ====================
function initMainInterface() {
    document.getElementById('serverTitle').textContent = serverData.info.name;
    document.getElementById('userInfo').textContent = `${currentUser.username} (${currentUser.role === 'admin' ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·'})`;
    
    if (isCloudServer) {
        document.getElementById('cloudServerBadge').style.display = 'inline-block';
        document.getElementById('syncTab').style.display = 'block';
    } else {
        document.getElementById('cloudServerBadge').style.display = 'none';
        document.getElementById('syncTab').style.display = 'none';
    }
    
    populateSelects();
    loadPersonnelList();
    loadUsersList();
    updateDashboard();
    loadSettingsInfo();
    
    // æ›´æ–°åŒæ­¥é¡µé¢ä¿¡æ¯
    if (isCloudServer) {
        updateSyncPageInfo();
    }
}

// ==================== æ›´æ–°åŒæ­¥é¡µé¢ä¿¡æ¯ ====================
function updateSyncPageInfo() {
    document.getElementById('lastSyncTime').textContent = 
        serverData.info.lastSync ? new Date(serverData.info.lastSync).toLocaleString() : 'ä»æœª';
    document.getElementById('currentServerInfo').textContent = serverData.info.name;
    document.getElementById('deviceId').textContent = deviceId;
    
    const syncStatus = cloudSyncEnabled ? 'online' : 'offline';
    const syncIndicator = document.getElementById('syncStatusIndicator');
    const syncStatusText = document.getElementById('syncStatusText');
    
    if (syncStatus === 'online') {
        syncIndicator.className = 'sync-indicator sync-green';
        syncStatusText.textContent = 'åœ¨çº¿åŒæ­¥';
    } else {
        syncIndicator.className = 'sync-indicator sync-yellow';
        syncStatusText.textContent = 'ç¦»çº¿æ¨¡å¼';
    }
    
    document.getElementById('autoSyncEnabled').checked = cloudSyncEnabled;
    
    document.getElementById('localRecordCount').textContent = serverData.personnel ? serverData.personnel.length : 0;
    document.getElementById('cloudRecordCount').textContent = serverData.personnel ? serverData.personnel.length : 0;
    document.getElementById('pendingChanges').textContent = '0';
}

// ==================== å¡«å……ä¸‹æ‹‰é€‰é¡¹ ====================
function populateSelects() {
    const personnelPosition = document.getElementById('personnelPosition');
    const personnelRank = document.getElementById('personnelRank');
    const newPosition = document.getElementById('newPosition');
    const newRank = document.getElementById('newRank');
    
    personnelPosition.innerHTML = '<option value="">è¯·é€‰æ‹©èŒä½</option>';
    newPosition.innerHTML = '<option value="">è¯·é€‰æ‹©æ–°èŒä½</option>';
    positions.forEach(pos => {
        personnelPosition.innerHTML += `<option value="${pos.id}">${pos.name}</option>`;
        newPosition.innerHTML += `<option value="${pos.id}">${pos.name}</option>`;
    });
    
    personnelRank.innerHTML = '<option value="">è¯·é€‰æ‹©å†›è¡”</option>';
    newRank.innerHTML = '<option value="">è¯·é€‰æ‹©æ–°å†›è¡”</option>';
    ranks.forEach(rank => {
        personnelRank.innerHTML += `<option value="${rank.id}">${rank.name}</option>`;
        newRank.innerHTML += `<option value="${rank.id}">${rank.name}</option>`;
    });
}

// ==================== åˆ‡æ¢æ ‡ç­¾é¡µ ====================
function switchTab(tabName) {
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
    
    event.target.classList.add('active');
    
    if (tabName === 'sync') {
        document.getElementById('syncTab-content').style.display = 'block';
        if (isCloudServer) {
            updateSyncPageInfo();
        }
    } else {
        document.getElementById(tabName + 'Tab').style.display = 'block';
    }
}

// ==================== äººå‘˜ç®¡ç† ====================
function showAddPersonnel() {
    document.getElementById('personnelName').value = '';
    document.getElementById('personnelPosition').value = '';
    document.getElementById('personnelRank').value = '';
    document.getElementById('addPersonnelModal').style.display = 'flex';
}

function addPersonnel() {
    const name = document.getElementById('personnelName').value.trim();
    const positionId = parseInt(document.getElementById('personnelPosition').value);
    const rankId = parseInt(document.getElementById('personnelRank').value);
    
    if (!name || !positionId || !rankId) {
        alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
        return;
    }
    
    const personnel = {
        id: Date.now().toString(),
        name: name,
        positionId: positionId,
        rankId: rankId,
        status: 'active'
    };
    
    if (!serverData.personnel) {
        serverData.personnel = [];
    }
    
    serverData.personnel.push(personnel);
    saveServerData();
    
    addLog('æ·»åŠ äººå‘˜', currentUser.username, `æ·»åŠ äººå‘˜: ${name}`);
    
    loadPersonnelList();
    loadPromoteList();
    updateDashboard();
    
    closeModal();
    
    if (isCloudServer) {
        showNotification(`âœ… å·²æ·»åŠ äººå‘˜: ${name}`);
    }
}

function loadPersonnelList() {
    const tbody = document.querySelector('#personnelTable tbody');
    tbody.innerHTML = '';
    
    if (!serverData.personnel || serverData.personnel.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#999">æš‚æ— äººå‘˜</td></tr>';
        return;
    }
    
    serverData.personnel.forEach(p => {
        const position = positions.find(pos => pos.id === p.positionId);
        const rank = ranks.find(r => r.id === p.rankId);
        
        tbody.innerHTML += `
            <tr>
                <td>${p.name}</td>
                <td>${position ? position.name : '-'}</td>
                <td><span class="badge" style="background:${getRankColor(p.rankId)}">${rank ? rank.name : '-'}</span></td>
                <td>${p.status === 'active' ? 'åœ¨èŒ' : 'ç¦»èŒ'}</td>
                <td>
                    <button class="action-btn action-btn-danger" onclick="removePersonnel('${p.id}')">åˆ é™¤</button>
                </td>
            </tr>
        `;
    });
}

function removePersonnel(id) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤äººå‘˜å—ï¼Ÿ')) return;
    
    const person = serverData.personnel.find(p => p.id === id);
    if (!person) return;
    
    serverData.personnel = serverData.personnel.filter(p => p.id !== id);
    saveServerData();
    
    addLog('åˆ é™¤äººå‘˜', currentUser.username, `åˆ é™¤äººå‘˜: ${person.name}`);
    
    loadPersonnelList();
    loadPromoteList();
    updateDashboard();
    
    if (isCloudServer) {
        showNotification(`ğŸ—‘ï¸ å·²åˆ é™¤äººå‘˜: ${person.name}`);
    }
}

// ==================== èŒä½æ™‹å‡ ====================
function loadPromoteList() {
    const select = document.getElementById('promoteSelect');
    select.innerHTML = '<option value="">è¯·é€‰æ‹©äººå‘˜</option>';
    
    if (!serverData.personnel) return;
    
    serverData.personnel.forEach(p => {
        select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
    });
}

function updatePromoteInfo() {
    const personId = document.getElementById('promoteSelect').value;
    const infoDiv = document.getElementById('promoteInfo');
    
    if (!personId) {
        infoDiv.style.display = 'none';
        return;
    }
    
    const person = serverData.personnel.find(p => p.id === personId);
    if (!person) return;
    
    document.getElementById('currentPosition').textContent = positions.find(p => p.id === person.positionId)?.name || '-';
    document.getElementById('currentRank').innerHTML = `<span class="badge" style="background:${getRankColor(person.rankId)}">${getRankName(person.rankId)}</span>`;
    
    infoDiv.style.display = 'block';
}

function promotePersonnel() {
    const personId = document.getElementById('promoteSelect').value;
    const newPositionId = parseInt(document.getElementById('newPosition').value);
    const newRankId = parseInt(document.getElementById('newRank').value);
    
    if (!personId || !newPositionId || !newRankId) {
        alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
        return;
    }
    
    const person = serverData.personnel.find(p => p.id === personId);
    if (!person) return;
    
    const oldPosition = getRankName(person.positionId);
    const oldRank = getRankName(person.rankId);
    
    person.positionId = newPositionId;
    person.rankId = newRankId;
    
    saveServerData();
    
    addLog('èŒä½æ™‹å‡', currentUser.username, 
        `${person.name}: ${oldPosition}/${oldRank} â†’ ${positions.find(p => p.id === newPositionId).name}/${getRankName(newRankId)}`);
    
    loadPersonnelList();
    updatePromoteInfo();
    updateDashboard();
    
    alert('æ™‹å‡æˆåŠŸï¼');
    
    if (isCloudServer) {
        showNotification(`â¬†ï¸ ${person.name} å·²æ™‹å‡`);
    }
}

// ==================== ç”¨æˆ·ç®¡ç† ====================
function showAddUser() {
    if (currentUser.role !== 'admin') {
        alert('åªæœ‰ç®¡ç†å‘˜å¯ä»¥æ·»åŠ ç”¨æˆ·');
        return;
    }
    
    document.getElementById('newUserUsername').value = '';
    document.getElementById('newUserPassword').value = '';
    document.getElementById('newUserRole').value = 'user';
    document.getElementById('addUserModal').style.display = 'flex';
}

function addUser() {
    const username = document.getElementById('newUserUsername').value.trim();
    const password = document.getElementById('newUserPassword').value.trim();
    const role = document.getElementById('newUserRole').value;
    
    if (!username || !password) {
        alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
        return;
    }
    
    if (serverData.users.some(u => u.username === username)) {
        alert('ç”¨æˆ·åå·²å­˜åœ¨');
        return;
    }
    
    const user = {
        id: Date.now().toString(),
        username: username,
        password: password,
        role: role,
        status: 'active'
    };
    
    serverData.users.push(user);
    saveServerData();
    
    addLog('æ·»åŠ ç”¨æˆ·', currentUser.username, `æ·»åŠ ç”¨æˆ·: ${username} (${role})`);
    
    loadUsersList();
    updateDashboard();
    
    closeModal();
    
    if (isCloudServer) {
        showNotification(`âœ… å·²æ·»åŠ ç”¨æˆ·: ${username}`);
    }
}

function loadUsersList() {
    const tbody = document.querySelector('#usersTable tbody');
    tbody.innerHTML = '';
    
    serverData.users.forEach(u => {
        tbody.innerHTML += `
            <tr>
                <td>${u.username}</td>
                <td>${u.role === 'admin' ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·'}</td>
                <td>${u.status === 'active' ? 'æ­£å¸¸' : 'ç¦ç”¨'}</td>
                <td>
                    ${u.id !== currentUser.id && currentUser.role === 'admin' ? 
                        `<button class="action-btn action-btn-danger" onclick="removeUser('${u.id}')">åˆ é™¤</button>` : 
                        '-'}
                </td>
            </tr>
        `;
    });
}

function removeUser(id) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤ç”¨æˆ·å—ï¼Ÿ')) return;
    
    const user = serverData.users.find(u => u.id === id);
    if (!user) return;
    
    serverData.users = serverData.users.filter(u => u.id !== id);
    saveServerData();
    
    addLog('åˆ é™¤ç”¨æˆ·', currentUser.username, `åˆ é™¤ç”¨æˆ·: ${user.username}`);
    
    loadUsersList();
    updateDashboard();
    
    if (isCloudServer) {
        showNotification(`ğŸ—‘ï¸ å·²åˆ é™¤ç”¨æˆ·: ${user.username}`);
    }
}

// ==================== ä»ªè¡¨ç›˜ ====================
function updateDashboard() {
    document.getElementById('totalPersonnel').textContent = serverData.personnel ? serverData.personnel.length : 0;
    document.getElementById('totalUsers').textContent = serverData.users.length;
    document.getElementById('totalLogs').textContent = serverData.logs.length;
    
    const logsDiv = document.getElementById('recentLogs');
    logsDiv.innerHTML = '';
    
    const recentLogs = serverData.logs.slice(-5).reverse();
    
    if (recentLogs.length === 0) {
        logsDiv.innerHTML = '<p style="text-align:center;color:#999;padding:20px">æš‚æ— æ“ä½œè®°å½•</p>';
        return;
    }
    
    logsDiv.innerHTML = '<table style="width:100%"><tbody>' +
        recentLogs.map(log => `
            <tr>
                <td style="width:180px;color:#666;font-size:14px">${new Date(log.timestamp).toLocaleString()}</td>
                <td style="font-weight:bold">${log.action}</td>
                <td style="color:#666">${log.user}</td>
                <td style="color:#999;font-size:14px">${log.details}</td>
            </tr>
        `).join('') +
        '</tbody></table>';
    
    loadLogsTable();
}

function loadLogsTable() {
    const tbody = document.querySelector('#logsTable tbody');
    tbody.innerHTML = '';
    
    const allLogs = [...serverData.logs].reverse();
    
    if (allLogs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#999">æš‚æ— æ“ä½œè®°å½•</td></tr>';
        return;
    }
    
    allLogs.forEach(log => {
        tbody.innerHTML += `
            <tr>
                <td>${new Date(log.timestamp).toLocaleString()}</td>
                <td>${log.action}</td>
                <td>${log.user}</td>
                <td>${log.details}</td>
            </tr>
        `;
    });
}

// ==================== è®¾ç½® ====================
function loadSettingsInfo() {
    if (!serverData.info) return;
    
    document.getElementById('settingsServerName').textContent = serverData.info.name;
    document.getElementById('settingsServerKey').textContent = serverData.info.key;
    document.getElementById('settingsCreateTime').textContent = new Date(serverData.info.createdAt).toLocaleString();
    
    const creator = serverData.users.find(u => u.id === serverData.info.creatorId);
    document.getElementById('settingsCreator').textContent = creator ? creator.username : '-';
    document.getElementById('settingsServerType').textContent = serverData.info.isCloud ? 'â˜ï¸ äº‘ç«¯æœåŠ¡å™¨' : 'ğŸ“± æœ¬åœ°æœåŠ¡å™¨';
}

// ==================== æ¨¡æ€æ¡†æ§åˆ¶ ====================
function closeModal() {
    document.querySelectorAll('.modal').forEach(modal => {
        modal.style.display = 'none';
    });
}

// ==================== é€€å‡ºç™»å½• ====================
function logout() {
    if (!confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) return;
    
    localStorage.removeItem('currentUser');
    localStorage.removeItem('currentServerKey');
    
    if (syncIntervalId) {
        clearInterval(syncIntervalId);
        syncIntervalId = null;
    }
    
    currentUser = null;
    currentServer = null;
    serverData = { info: null, users: [], personnel: [], logs: [] };
    isCloudServer = false;
    cloudSyncEnabled = false;
    
    document.getElementById('mainContainer').style.display = 'none';
    document.getElementById('loginContainer').style.display = 'block';
    
    updateCloudStatus('offline');
    
    document.getElementById('serverKey').value = '';
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
    document.getElementById('loginError').style.display = 'none';
    
    document.getElementById('serverKey').focus();
}

// ==================== åˆ é™¤æœåŠ¡å™¨ ====================
function canDeleteServer() {
    if (!currentServer || !serverData.info) return false;
    
    const user = serverData.users.find(u => u.id === currentUser.id);
    if (!user) return false;
    
    if (user.id === serverData.info.creatorId) {
        return true;
    }
    
    if (isCloudServer) {
        loadPersonnelList();
        loadPromoteList();
        updateDashboard();
    }
}

function showDeleteModal() {
    if (!currentServer || !serverData.info) return;
    
    const user = serverData.users.find(u => u.id === currentUser.id);
    if (!user || user.id !== serverData.info.creatorId) {
        alert('åªæœ‰æœåŠ¡å™¨åˆ›å»ºè€…å¯ä»¥åˆ é™¤æœåŠ¡å™¨');
        return;
    }
    
    document.getElementById('deleteServerName').textContent = serverData.info.name;
    document.getElementById('deleteConfirmPassword').value = '';
    document.getElementById('deleteModal').style.display = 'flex';
}

function confirmDeleteServer() {
    const password = document.getElementById('deleteConfirmPassword').value;
    const user = serverData.users.find(u => u.id === currentUser.id);
    
    if (!user || user.password !== password) {
        alert('å¯†ç é”™è¯¯');
        return;
    }
    
    if (confirm('âš ï¸ æœ€åç¡®è®¤ï¼åˆ é™¤æœåŠ¡å™¨å°†æ°¸ä¹…åˆ é™¤æ‰€æœ‰æ•°æ®ï¼ç¡®å®šç»§ç»­å—ï¼Ÿ')) {
        if (isCloudServer) {
            localStorage.removeItem(CLOUD_CONFIG.CLOUD_PREFIX + currentServer.key);
        } else {
            localStorage.removeItem('server_' + currentServer.key);
        }
        
        localStorage.removeItem('currentUser');
        localStorage.removeItem('currentServerKey');
        
        alert('æœåŠ¡å™¨åˆ é™¤æˆåŠŸï¼');
        
        currentUser = null;
        currentServer = null;
        serverData = { info: null, users: [], logs: [] };
        isCloudServer = false;
        cloudSyncEnabled = false;
        
        if (syncIntervalId) {
            clearInterval(syncIntervalId);
            syncIntervalId = null;
        }
        
        document.getElementById('mainContainer').style.display = 'none';
        document.getElementById('loginContainer').style.display = 'block';
        closeModal();
        
        document.getElementById('secretCode').value = '';
        document.getElementById('secretCode').focus();
    }
}

// å†²çªè§£å†³å‡½æ•°ï¼ˆç®€åŒ–ï¼‰
function resolveConflict(choice) {
    document.getElementById('conflictModal').style.display = 'none';
    showNotification(`ä½¿ç”¨${choice === 'local' ? 'æœ¬åœ°' : choice === 'cloud' ? 'äº‘ç«¯' : 'åˆå¹¶'}æ•°æ®`);
}

// ==================== ä¿®æ”¹ä¿å­˜æœåŠ¡å™¨æ•°æ®å‡½æ•° ====================

// ä¿®æ”¹ä¿å­˜æœåŠ¡å™¨æ•°æ®å‡½æ•°
function saveServerData() {
    if (!currentServer || !currentServer.key) return;
    
    // æ›´æ–°æœ€ååŒæ­¥æ—¶é—´
    if (serverData.info) {
        serverData.info.lastSync = new Date().toISOString();
    }
    
    // æ ¹æ®æœåŠ¡å™¨ç±»å‹ä¿å­˜
    if (isCloudServer) {
        localStorage.setItem(CLOUD_CONFIG.CLOUD_PREFIX + currentServer.key, JSON.stringify(serverData));
    } else {
        localStorage.setItem('server_' + currentServer.key, JSON.stringify(serverData));
    }
}

// ==================== ä¿æŒåŸæœ‰çš„è¾…åŠ©å‡½æ•° ====================
function getRankName(rankId) {
    const rank = ranks.find(r => r.id === rankId);
    return rank ? rank.name : 'æœªçŸ¥';
}

function getRankColor(rankId) {
    const rank = ranks.find(r => r.id === rankId);
    return rank ? rank.color : '#8c8c8c';
}

function addLog(action, user, details) {
    const log = {
        action: action,
        user: user,
        timestamp: new Date().toISOString(),
        details: details
    };
    
    serverData.logs.push(log);
    if (serverData.logs.length > 100) {
        serverData.logs = serverData.logs.slice(-100);
    }
    
    saveServerData();
    
    if (document.getElementById('dashboardTab').style.display !== 'none') {
        updateDashboard();
    }
}

// ==================== åŸæœ‰çš„é”å®šç³»ç»Ÿå‡½æ•° ====================
function checkLockStatus() {
    const now = Date.now();
    const lockData = localStorage.getItem('system_lock');
    
    if (lockData) {
        const lockInfo = JSON.parse(lockData);
        lockUntil = lockInfo.lockUntil;
        
        if (now < lockUntil) {
            showLockScreen(lockUntil - now);
            return false;
        } else {
            localStorage.removeItem('system_lock');
            localStorage.removeItem('failed_attempts');
            failedAttempts = 0;
            updateAttemptsDisplay();
            hideLockScreen();
            return true;
        }
    }
    
    hideLockScreen();
    return true;
}

function showLockScreen(remainingTime) {
    const lockScreen = document.getElementById('lockScreen');
    const lockTimeSpan = document.getElementById('lockTime');
    
    lockScreen.style.display = 'flex';
    document.getElementById('authContainer').style.display = 'none';
    document.getElementById('loginContainer').style.display = 'none';
    document.getElementById('mainContainer').style.display = 'none';
    
    function updateCountdown() {
        const now = Date.now();
        const timeLeft = lockUntil - now;
        
        if (timeLeft <= 0) {
            hideLockScreen();
            return;
        }
        
        const minutes = Math.floor(timeLeft / 60000);
        const seconds = Math.floor((timeLeft % 60000) / 1000);
        lockTimeSpan.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        setTimeout(updateCountdown, 1000);
    }
    
    updateCountdown();
}

function hideLockScreen() {
    document.getElementById('lockScreen').style.display = 'none';
    document.getElementById('authContainer').style.display = 'block';
    setTimeout(() => {
        document.getElementById('secretCode').focus();
    }, 100);
}

function loadAttempts() {
    const attemptsData = localStorage.getItem('failed_attempts');
    failedAttempts = attemptsData ? parseInt(attemptsData) || 0 : 0;
    updateAttemptsDisplay();
}

function saveAttempts() {
    localStorage.setItem('failed_attempts', failedAttempts.toString());
}

function lockSystem() {
    lockUntil = Date.now() + LOCK_TIME;
    localStorage.setItem('system_lock', JSON.stringify({
        lockUntil: lockUntil,
        lockedAt: new Date().toISOString()
    }));
    showLockScreen(LOCK_TIME);
}

function updateAttemptsDisplay() {
    const attemptsLeft = MAX_ATTEMPTS - failedAttempts;
    document.getElementById('attemptsLeft').textContent = attemptsLeft;
    
    if (attemptsLeft <= 1) {
        document.getElementById('attemptsLeft').style.color = '#d32f2f';
        document.getElementById('attemptsLeft').style.fontWeight = 'bold';
    } else if (attemptsLeft <= 2) {
        document.getElementById('attemptsLeft').style.color = '#f57c00';
    } else {
        document.getElementById('attemptsLeft').style.color = '#666';
    }
}

</script>
</body>
</html>
